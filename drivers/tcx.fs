\
\ Fcode payload for QEMU TCX graphics card
\
\ This is the Forth source for an Fcode payload to initialise
\ the QEMU TCX graphics card.
\

fcode-version3

\
\ Instead of using fixed values for the framebuffer address and the width
\ and height, grab the ones passed in by QEMU/generated by OpenBIOS
\

: qemu-video-addr
  " qemu-video-addr" $find if
    cell+ @
  then
;

: qemu-video-width
  " qemu-video-width" $find if
    cell+ @
  then
;

: qemu-video-height
  " qemu-video-height" $find if
    cell+ @
  then
;

: qemu-tcx-driver-install ( -- )
  qemu-video-addr to frame-buffer-adr
  default-font set-font
  qemu-video-width qemu-video-height over char-width / over char-height /
  fb8-install
;

: qemu-tcx-driver-init
  ['] qemu-tcx-driver-install is-install
;

qemu-tcx-driver-init

end0
